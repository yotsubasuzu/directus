import{defineModule as e}from"@directus/extensions-sdk";import{defineComponent as l,resolveComponent as o,openBlock as a,createBlock as t,unref as n,withCtx as i,createVNode as r,createTextVNode as d,toDisplayString as u,ref as s,createElementBlock as c,createElementVNode as f,toRefs as v,computed as m,watch as p,resolveDirective as _,withDirectives as y,isRef as b,createCommentVNode as h}from"vue";import{useDialogRoute as g}from"@/composables/use-dialog-route";import{useI18n as k}from"vue-i18n";import{useRouter as w}from"vue-router";import C from"@/modules/files/routes/collection.vue";import V from"@/api";import{useEditsGuard as A}from"@/composables/use-edits-guard";import{useItem as x}from"@/composables/use-item";import{useShortcut as E}from"@/composables/use-shortcut";import{getAssetUrl as T}from"@/utils/get-asset-url";import{notify as S}from"@/utils/notify";import{unexpectedError as U}from"@/utils/unexpected-error";import $ from"@/views/private/components/comments-sidebar-detail.vue";import R from"@/views/private/components/file-preview.vue";import D from"@/views/private/components/files-navigation.vue";import K from"@/views/private/components/folder-picker.vue";import N from"@/views/private/components/image-editor.vue";import F from"@/views/private/components/revisions-drawer-detail.vue";import I from"@/views/private/components/save-options.vue";import O from"@/modules/files/components/file-info-sidebar-detail.vue";import j from"@/modules/files/routes/not-found.vue";var B=l({__name:"add-new",props:{folder:{}},setup(e){const l=e,{t:s}=k(),c=w(),f=g();function v(){c.push(l.folder?{path:`/files/folders/${l.folder}`}:{path:"/files"})}return(e,c)=>{const m=o("v-card-title"),p=o("v-upload"),_=o("v-card-text"),y=o("v-button"),b=o("v-card-actions"),h=o("v-card"),g=o("v-dialog");return a(),t(g,{"model-value":n(f),"onUpdate:modelValue":v,onEsc:v},{default:i((()=>[r(h,null,{default:i((()=>[r(m,null,{default:i((()=>[d(u(n(s)("add_file")),1)])),_:1}),r(_,null,{default:i((()=>[r(p,{folder:l.folder,"from-url":!1,multiple:"",onInput:v},null,8,["folder"])])),_:1}),r(b,null,{default:i((()=>[r(y,{secondary:"",onClick:v},{default:i((()=>[d(u(n(s)("done")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["model-value"])}}}),P=(e,l)=>{const o=e.__vccOpts||e;for(const[e,a]of l)o[e]=a;return o},W=P(B,[["__file","add-new.vue"]]);const q={class:"file-preview-replace"};var z=l({__name:"file-preview-replace",props:{file:{},preset:{},inModal:{type:Boolean}},emits:["click","replace"],setup(e,{emit:l}){const t=l,{t:v}=k(),m=s(!1);function p(){m.value=!1,t("replace")}return(e,l)=>{const t=o("v-card-title"),s=o("v-upload"),_=o("v-card-text"),y=o("v-button"),b=o("v-card-actions"),h=o("v-card"),g=o("v-dialog");return a(),c("div",q,[r(R,{file:e.file},null,8,["file"]),f("button",{class:"replace-toggle",onClick:l[0]||(l[0]=e=>m.value=!0)},u(n(v)("replace_file")),1),r(g,{"model-value":m.value,onEsc:l[2]||(l[2]=e=>m.value=!1)},{default:i((()=>[r(h,null,{default:i((()=>[r(t,null,{default:i((()=>[d(u(n(v)("replace_file")),1)])),_:1}),r(_,null,{default:i((()=>[r(s,{"file-id":e.file.id,"from-url":!1,onInput:p},null,8,["file-id"])])),_:1}),r(b,null,{default:i((()=>[r(y,{secondary:"",onClick:l[1]||(l[1]=e=>m.value=!1)},{default:i((()=>[d(u(n(v)("done")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["model-value"])])}}}),L=[],M=[];function G(e,l){if(e&&"undefined"!=typeof document){var o,a=!0===l.prepend?"prepend":"append",t=!0===l.singleTag,n="string"==typeof l.container?document.querySelector(l.container):document.getElementsByTagName("head")[0];if(t){var i=L.indexOf(n);-1===i&&(i=L.push(n)-1,M[i]={}),o=M[i]&&M[i][a]?M[i][a]:M[i][a]=r()}else o=r();65279===e.charCodeAt(0)&&(e=e.substring(1)),o.styleSheet?o.styleSheet.cssText+=e:o.appendChild(document.createTextNode(e))}function r(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),l.attributes)for(var o=Object.keys(l.attributes),t=0;t<o.length;t++)e.setAttribute(o[t],l.attributes[o[t]]);var i="prepend"===a?"afterbegin":"beforeend";return n.insertAdjacentElement(i,e),e}}G("\n.replace-toggle[data-v-3fbcfb1b] {\r\n  color: var(--theme--primary);\r\n  cursor: pointer;\r\n  font-weight: 600;\r\n  margin-top: 12px;\n}\r\n",{});var H=P(z,[["__scopeId","data-v-3fbcfb1b"],["__file","file-preview-replace.vue"]]);const J={class:"file-item"};var Q=l({__name:"item",props:{primaryKey:{}},setup(e){const l=e,{t:c}=k(),g=w(),C=s(),{primaryKey:R}=v(l),{breadcrumb:B}={breadcrumb:m((()=>{var e;return(null==(e=null==L?void 0:L.value)?void 0:e.folder)?[{name:c("file_library"),to:{path:`/files/folders/${L.value.folder}`}}]:[{name:c("file_library"),to:"/files"}]}))},P=s(null),{isNew:W,edits:q,hasEdits:z,item:L,permissions:M,saving:G,loading:Q,save:X,remove:Y,deleting:Z,saveAsCopy:ee,refresh:le,validationErrors:oe}=x(s("directus_files"),R),{collectionPermissions:{createAllowed:ae,revisionsAllowed:te},itemPermissions:{updateAllowed:ne,deleteAllowed:ie,saveAllowed:re,fields:de}}=M,ue=m((()=>re.value&&z.value)),{confirmLeave:se,leaveTo:ce}=A(z),fe=s(!1),ve=s(!1),me=["type","width","height","filesize","uploaded_by","uploaded_on","modified_by","modified_on","duration","folder","charset","embed"],pe=m((()=>{var e;return L.value&&(null==(e=L.value)?void 0:e.folder)?`/files/folders/${L.value.folder}`:"/files"})),{moveToDialogActive:_e,moveToFolder:ye,moving:be,selectedFolder:he}=function(){const e=s(!1),o=s(!1),a=s(null);return p(L,(()=>{var e;a.value=(null==(e=L.value)?void 0:e.folder)||null})),{moveToDialogActive:e,moving:o,moveToFolder:async function(){var t;o.value=!0;try{const e=await V.patch(`/files/${l.primaryKey}`,{folder:a.value},{params:{fields:"folder.name"}});le();const o=(null==(t=e.data.data.folder)?void 0:t.name)||c("file_library");S({title:c("file_moved",{folder:o}),icon:"folder_move"})}catch(e){U(e)}finally{e.value=!1,o.value=!1}},selectedFolder:a}}();E("meta+s",Ce,C);const ge=m((()=>de.value.filter((e=>!1===me.includes(e.field)))));function ke(){var e;const l=g.options.history.state.back;"string"==typeof l&&l.startsWith("/login")?(null==(e=null==L?void 0:L.value)?void 0:e.folder)?g.push(`/files/folders/${L.value.folder}`):g.push("/files"):g.back()}async function we(){try{await X(),g.push(pe.value)}catch{}}async function Ce(){var e,l;try{await X(),null==(l=null==(e=P.value)?void 0:e.refresh)||l.call(e),le()}catch{}}async function Ve(){const e=await ee();e&&g.push(`/files/${e}`)}async function Ae(){try{await Y(),q.value={},g.replace(pe.value)}catch{fe.value=!1}}function xe(){ce.value&&(q.value={},se.value=!1,g.push(ce.value))}function Ee(){q.value={},se.value=!1}return(e,s)=>{const v=o("v-icon"),m=o("v-button"),p=o("v-breadcrumb"),g=o("v-card-title"),k=o("v-card-actions"),w=o("v-card"),V=o("v-dialog"),A=o("v-card-text"),x=o("v-form"),E=o("private-view"),S=_("tooltip");return n(Q)||n(L)?(a(),t(E,{key:1,title:n(Q)||!n(L)?n(c)("loading"):n(L).title},{"title-outer:prepend":i((()=>[r(m,{class:"header-icon",rounded:"",icon:"",secondary:"",exact:"",onClick:ke},{default:i((()=>[r(v,{name:"arrow_back"})])),_:1})])),headline:i((()=>[r(p,{items:n(B)},null,8,["items"])])),actions:i((()=>{var e,o,f;return[r(V,{modelValue:fe.value,"onUpdate:modelValue":s[1]||(s[1]=e=>fe.value=e),onEsc:s[2]||(s[2]=e=>fe.value=!1)},{activator:i((({on:e})=>[y((a(),t(m,{rounded:"",icon:"",class:"action-delete",secondary:"",disabled:null===n(L)||!1===n(ie),onClick:e},{default:i((()=>[r(v,{name:"delete",outline:""})])),_:2},1032,["disabled","onClick"])),[[S,n(ie)?n(c)("delete_label"):n(c)("not_allowed"),void 0,{bottom:!0}]])])),default:i((()=>[r(w,null,{default:i((()=>[r(g,null,{default:i((()=>[d(u(n(c)("delete_are_you_sure")),1)])),_:1}),r(k,null,{default:i((()=>[r(m,{secondary:"",onClick:s[0]||(s[0]=e=>fe.value=!1)},{default:i((()=>[d(u(n(c)("cancel")),1)])),_:1}),r(m,{kind:"danger",loading:n(Z),onClick:Ae},{default:i((()=>[d(u(n(c)("delete_label")),1)])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),!1===n(W)?(a(),t(V,{key:0,modelValue:n(_e),"onUpdate:modelValue":s[5]||(s[5]=e=>b(_e)?_e.value=e:null),onEsc:s[6]||(s[6]=e=>_e.value=!1)},{activator:i((({on:e})=>[y((a(),t(m,{rounded:"",icon:"",disabled:null===n(L),secondary:"",onClick:e},{default:i((()=>[r(v,{name:"folder_move"})])),_:2},1032,["disabled","onClick"])),[[S,n(c)("move_to_folder"),void 0,{bottom:!0}]])])),default:i((()=>[r(w,null,{default:i((()=>[r(g,null,{default:i((()=>[d(u(n(c)("move_to_folder")),1)])),_:1}),r(A,null,{default:i((()=>[r(K,{modelValue:n(he),"onUpdate:modelValue":s[3]||(s[3]=e=>b(he)?he.value=e:null)},null,8,["modelValue"])])),_:1}),r(k,null,{default:i((()=>[r(m,{secondary:"",onClick:s[4]||(s[4]=e=>_e.value=!1)},{default:i((()=>[d(u(n(c)("cancel")),1)])),_:1}),r(m,{loading:n(be),onClick:n(ye)},{default:i((()=>[d(u(n(c)("move")),1)])),_:1},8,["loading","onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"])):h("v-if",!0),y((a(),t(m,{secondary:"",icon:"",rounded:"",download:null==(e=n(L))?void 0:e.filename_download,href:n(T)(l.primaryKey,!0)},{default:i((()=>[r(v,{name:"download"})])),_:1},8,["download","href"])),[[S,n(c)("download"),void 0,{bottom:!0}]]),(null==(f=null==(o=n(L))?void 0:o.type)?void 0:f.includes("image"))?y((a(),t(m,{key:1,rounded:"",icon:"",secondary:"",onClick:s[7]||(s[7]=e=>ve.value=!0)},{default:i((()=>[r(v,{name:"tune"})])),_:1})),[[S,n(c)("edit"),void 0,{bottom:!0}]]):h("v-if",!0),y((a(),t(m,{rounded:"",icon:"",loading:n(G),disabled:!ue.value,onClick:we},{"append-outer":i((()=>[ue.value?(a(),t(I,{key:0,"disabled-options":n(ae)?["save-and-add-new"]:["save-and-add-new","save-as-copy"],onSaveAndStay:Ce,onSaveAsCopy:Ve,onDiscardAndStay:Ee},null,8,["disabled-options"])):h("v-if",!0)])),default:i((()=>[r(v,{name:"check"})])),_:1},8,["loading","disabled"])),[[S,n(re)?n(c)("save"):n(c)("not_allowed"),void 0,{bottom:!0}]])]})),navigation:i((()=>{var e,l;return[r(D,{"current-folder":null!=(l=null==(e=n(L))?void 0:e.folder)?l:void 0},null,8,["current-folder"])]})),sidebar:i((()=>[r(O,{file:n(L),"is-new":n(W)},null,8,["file","is-new"]),!1===n(W)&&n(te)?(a(),t(F,{key:0,ref_key:"revisionsDrawerDetailRef",ref:P,collection:"directus_files","primary-key":n(R)},null,8,["primary-key"])):h("v-if",!0),!1===n(W)?(a(),t($,{key:1,collection:"directus_files","primary-key":n(R)},null,8,["primary-key"])):h("v-if",!0)])),default:i((()=>{var e,l;return[f("div",J,[n(L)?(a(),t(H,{key:0,class:"preview",file:n(L),onReplace:n(le)},null,8,["file","onReplace"])):h("v-if",!0),(null==(l=null==(e=n(L))?void 0:e.type)?void 0:l.startsWith("image"))?(a(),t(N,{key:1,id:n(L).id,modelValue:ve.value,"onUpdate:modelValue":s[8]||(s[8]=e=>ve.value=e),onRefresh:n(le)},null,8,["id","modelValue","onRefresh"])):h("v-if",!0),r(x,{ref_key:"form",ref:C,modelValue:n(q),"onUpdate:modelValue":s[9]||(s[9]=e=>b(q)?q.value=e:null),fields:ge.value,loading:n(Q),"initial-values":n(L),"primary-key":n(R),disabled:!1===n(ne),"validation-errors":n(oe)},null,8,["modelValue","fields","loading","initial-values","primary-key","disabled","validation-errors"])]),r(V,{modelValue:n(se),"onUpdate:modelValue":s[11]||(s[11]=e=>b(se)?se.value=e:null),onEsc:xe},{default:i((()=>[r(w,null,{default:i((()=>[r(g,null,{default:i((()=>[d(u(n(c)("unsaved_changes")),1)])),_:1}),r(A,null,{default:i((()=>[d(u(n(c)("unsaved_changes_copy")),1)])),_:1}),r(k,null,{default:i((()=>[r(m,{secondary:"",onClick:xe},{default:i((()=>[d(u(n(c)("discard_changes")),1)])),_:1}),r(m,{onClick:s[10]||(s[10]=e=>se.value=!1)},{default:i((()=>[d(u(n(c)("keep_editing")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])]})),_:1},8,["title"])):(a(),t(j,{key:0}))}}});G(".action-delete[data-v-0a50060f] {\n  --v-button-background-color-hover: var(--theme--danger) !important;\n  --v-button-color-hover: var(--white) !important;\n}\n\n.header-icon.secondary[data-v-0a50060f] {\n  --v-button-background-color: var(--theme--background-normal);\n}\n\n.file-item[data-v-0a50060f] {\n  padding: var(--content-padding);\n  padding-bottom: var(--content-padding-bottom);\n}\n\n.preview[data-v-0a50060f] {\n  margin-bottom: var(--theme--form--row-gap);\n}",{});var X=e({id:"files",name:"$t:file_library",icon:"folder",routes:[{name:"files-collection",path:"",component:C,children:[{path:"+",name:"add-file",components:{addNew:W}}]},{name:"files-item",path:":primaryKey",component:P(Q,[["__scopeId","data-v-0a50060f"],["__file","item.vue"]]),props:!0},{path:"folders",redirect:"/files"},{name:"folders-collection",path:"folders/:folder",component:C,props:!0,children:[{path:"+",name:"add-file-folder",components:{addNew:W}}]},{path:"all",component:C,props:{special:"all"}},{path:"mine",component:C,props:{special:"mine"}},{path:"recent",component:C,props:{special:"recent"}}],preRegisterCheck(e,l){if(e.role.admin_access)return!0;return!!l.find((e=>"directus_files"===e.collection&&"read"===e.action))}});export{X as default};
